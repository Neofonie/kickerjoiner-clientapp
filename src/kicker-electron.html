<div class="window" style="display: none;" id="kicker">
    <input type="text"
           name="nick"
           placeholder="nickname"
           onkeypress="(event.key.toLowerCase() === 'enter') ? callPlusOne() : null" />
    <button onclick="callPlusOne()" id="plusone">+1</button>
    <button onclick="callGOGOGO()" id="gogogo" style="display:none;">GOGOGO</button>
    <pre id="gamestate" style="max-height:150px;overflow-y: scroll;"></pre>
    <br /><br />
    <button onclick="connectToWSS()">reconnect</button>
</div>

<script>
    const WebSocket = require("ws");

    const onlineApi = '\'https://kij.willy-selma.de/db';
    const wsApi = 'wss://kij.willy-selma.de/ws';

    document.querySelector('#kicker').style = '';
    document.querySelector('title').innerHTML = 'Kicker joiner';

    // client part
    let pingTimeout = null;
    let socket;
    let gameid = -1;

    function heartbeat() {
        console.log('heartbeat');
        if (pingTimeout !== null) {
            clearTimeout(pingTimeout);
        }

        // Use `WebSocket#terminate()`, which immediately destroys the connection,
        // instead of `WebSocket#close()`, which waits for the close timer.
        // Delay should be equal to the interval at which your server
        // sends out pings plus a conservative assumption of the latency.
        pingTimeout = setTimeout(() => {
            if (socket) {
                console.log('heartbeat.terminate');
                socket.terminate();
            }
        }, 30000 + 1000);
    }

    function sendMessage(data) {
        console.log('sendMessage', data, socket)
        if (socket) {
            socket.send(JSON.stringify(data));
        }
    }

    function connectToWSS() {
        console.log('connectToWSS', wsApi);
        socket = new WebSocket(wsApi);

        socket.on('message' ,async (json) => {
            console.log('socket.message', json);
            const data = JSON.parse(json);
            console.log(data);
            switch (data.message) {
                case 'CONNECTION_ON': // connection with server is on
                    // store date && clientid
                    break;
                case 'GAME_UPDATE': // joined game got an update
                    // store data.gameid to compare joined game
                    // ----
                    // GET fetch /db/games/data.gameid
                    const game = await db('GET', '/games/' + data.gameid);
                    document.querySelector('#gamestate').innerHTML = JSON.stringify(game, null, 2);
                    // refresh state to rerender
                    gameid = data.gameid;
                    break;
                case 'GAME_READY': // four joiners in one game
                    // now activate gogogo button
                    document.querySelector('#gogogo').style = 'display: inline-block;';
                    document.querySelector('#plusone').style = 'display: none;';
                    gameid = data.gameid;
                    // vibrate app
                    // ----
                    // GET fetch /db/games/data.gameid
                    // refresh state to rerender
                    break;
                case 'GAME_GOGOGO': // all four joiners pressed gogog in one game
                    // vibrate app
                    // gogogo screen
                    // ----
                    // GET fetch /db/games/data.gameid
                    // refresh state to rerender
                    // ----
                    // clear state for new game
                    break;
            }
        });

        socket.on('open', heartbeat);
        socket.on('ping', heartbeat);
        socket.on('error', (e) => {
            console.log('socket.error', e);
        });
        socket.on('close', (e) => {
            console.log('socket.close', e);
            clearTimeout(pingTimeout);
        });
    }

    function getTimestampNow() {
        return Math.floor(Date.now() / 1000);
    }

    async function db(method, url, data) {
        return await fetch(onlineApi + url, {
            method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        }).then((res) => res.json());
    }

    connectToWSS();

    function callPlusOne() {
        const nickname = document.querySelector('input[name=nick]').value;
        sendMessage({
            message: 'PLUS_ONE',
            nick: nickname || 'willy',
        });
    }

    function callGOGOGO() {
        sendMessage({
            message: 'GOGOGO',
            gameid: gameid,
        });
    }

    const alertOnlineStatus = () => {
        // if (!navigator.onLine) {
        //     wss.terminate();
        //     wss = null;
        // } else {
        //     exposeIPForReciever();
        // }
        document.getElementById('network').innerHTML = (navigator.onLine ? 'on' : 'off') + 'line';
    };

    window.addEventListener('online', alertOnlineStatus);
    window.addEventListener('offline', alertOnlineStatus);
</script>